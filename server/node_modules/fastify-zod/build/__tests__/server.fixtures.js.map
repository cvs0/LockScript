{"version":3,"file":"server.fixtures.js","names":["_fastify","_interopRequireDefault","require","_httpErrors","_","obj","__esModule","default","swaggerOptions","swagger","info","title","description","version","exports","openApiOptions","openapi","swaggerUiOptions","staticCSP","createTestServer","fastifyOptions","registerOptions","f","register","fastify","state","todoItems","zod","get","operationId","reply","key","done","filter","item","inProgress","todo","post","body","nextItem","some","prevItem","id","BadRequest","params","response","find","code","message","put","NotFound","map"],"sources":["../../src/__tests__/server.fixtures.ts"],"sourcesContent":["import fastify, { FastifyInstance, FastifyServerOptions } from \"fastify\";\nimport { BadRequest, NotFound } from \"http-errors\";\n\nimport { register } from \"..\";\nimport { RegisterOptions } from \"../FastifyZod\";\n\nimport { models, TodoItems } from \"./models.fixtures\";\n\nexport const swaggerOptions: RegisterOptions<typeof models>[`swaggerOptions`] =\n  {\n    swagger: {\n      info: {\n        title: `Fastify Zod Test Server`,\n        description: `Test Server for Fastify Zod`,\n        version: `0.0.0`,\n      },\n    },\n  };\n\nexport const openApiOptions: RegisterOptions<typeof models>[`swaggerOptions`] =\n  {\n    openapi: {\n      info: {\n        title: `Fastify Zod Test Server`,\n        description: `Test Server for Fastify Zod`,\n        version: `0.0.0`,\n      },\n    },\n  };\n\nexport const swaggerUiOptions: RegisterOptions<\n  typeof models\n>[`swaggerUiOptions`] = {\n  staticCSP: true,\n};\n\nexport const createTestServer = async (\n  fastifyOptions: FastifyServerOptions,\n  registerOptions: RegisterOptions<typeof models>,\n): Promise<FastifyInstance> => {\n  const f = await register(fastify(fastifyOptions), registerOptions);\n\n  const state: TodoItems = {\n    todoItems: [],\n  };\n\n  f.zod.get(\n    `/item`,\n    {\n      operationId: `getTodoItems`,\n      reply: {\n        description: `The list of Todo Items`,\n        key: `TodoItems`,\n      },\n    },\n    async () => state,\n  );\n\n  f.zod.get(\n    `/item/grouped-by-status`,\n    {\n      operationId: `getTodoItemsGroupedByStatus`,\n      reply: `TodoItemsGroupedByStatus`,\n    },\n    async () => ({\n      done: state.todoItems.filter((item) => item.state === `done`),\n      inProgress: state.todoItems.filter(\n        (item) => item.state === `in progress`,\n      ),\n      todo: state.todoItems.filter((item) => item.state === `todo`),\n    }),\n  );\n\n  f.zod.post(\n    `/item`,\n    {\n      operationId: `postTodoItem`,\n      body: `TodoItem`,\n      reply: `TodoItems`,\n    },\n    async ({ body: nextItem }) => {\n      if (state.todoItems.some((prevItem) => prevItem.id === nextItem.id)) {\n        throw new BadRequest(`item already exists`);\n      }\n      state.todoItems = [...state.todoItems, nextItem];\n      return state;\n    },\n  );\n\n  f.zod.get(\n    `/item/:id`,\n    {\n      operationId: `getTodoItem`,\n      params: `TodoItemId`,\n      response: {\n        200: `TodoItem`,\n        404: `TodoItemNotFoundError`,\n      },\n    },\n    async ({ params: { id } }, reply) => {\n      const item = state.todoItems.find((item) => item.id === id);\n      if (item) {\n        return item;\n      }\n      reply.code(404);\n      return {\n        id,\n        message: `item not found`,\n      };\n    },\n  );\n\n  f.zod.put(\n    `/item/:id`,\n    {\n      operationId: `putTodoItem`,\n      body: `TodoItem`,\n      params: `TodoItemId`,\n      reply: `TodoItem`,\n    },\n    async ({ params: { id }, body: nextItem }) => {\n      if (!state.todoItems.some((prevItem) => prevItem.id === id)) {\n        throw new NotFound(`no such item`);\n      }\n      state.todoItems = state.todoItems.map((prevItem) =>\n        prevItem.id === id ? nextItem : prevItem,\n      );\n      return nextItem;\n    },\n  );\n\n  f.zod.get(\n    `/42`,\n    { operationId: `getFortyTwo`, reply: `FortyTwo` },\n    async () => 42,\n  );\n\n  return f;\n};\n"],"mappings":"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"}