{"version":3,"file":"FastifyZod.test.js","names":["_JsonSchema","require","_models","_server","test","jsonSchemas","buildJsonSchemas","models","errorMessages","f","createTestServer","ajv","customOptions","allErrors","plugins","transformSpec","options","mergeRefs","$ref","expect","inject","method","url","then","res","json","resolves","toEqual","todoItems","payload","code","error","message","statusCode","id","label","state","response","body","dueDateMs","Date","getTime"],"sources":["../../src/__tests__/FastifyZod.test.ts"],"sourcesContent":["import { buildJsonSchemas } from \"../JsonSchema\";\n\nimport { models } from \"./models.fixtures\";\nimport { createTestServer } from \"./server.fixtures\";\n\ntest(`FastifyZod`, async () => {\n  const jsonSchemas = buildJsonSchemas(models, { errorMessages: true });\n  const f = await createTestServer(\n    {\n      ajv: {\n        customOptions: {\n          allErrors: true,\n        },\n        plugins: [require(`ajv-errors`)],\n      },\n    },\n    {\n      jsonSchemas,\n      transformSpec: {\n        options: {\n          mergeRefs: [jsonSchemas.$ref(`TodoState`)],\n        },\n      },\n    },\n  );\n\n  await expect(\n    f\n      .inject({\n        method: `get`,\n        url: `/item`,\n      })\n      .then((res) => res.json()),\n  ).resolves.toEqual({ todoItems: [] });\n\n  await expect(\n    f\n      .inject({\n        method: `post`,\n        url: `/item`,\n        payload: {},\n      })\n      .then((res) => res.json()),\n  ).resolves.toEqual({\n    code: `FST_ERR_VALIDATION`,\n    error: `Bad Request`,\n    message: `body must have required property 'id', body must have required property 'label', body must have required property 'state'`,\n    statusCode: 400,\n  });\n\n  await expect(\n    f\n      .inject({\n        method: `post`,\n        url: `/item`,\n        payload: {\n          id: 1337,\n          label: `todo`,\n          state: `todo`,\n        },\n      })\n      .then((res) => res.json()),\n  ).resolves.toEqual({\n    code: `FST_ERR_VALIDATION`,\n    error: `Bad Request`,\n    message: `body/id invalid todo item id`,\n    statusCode: 400,\n  });\n\n  await expect(\n    f\n      .inject({\n        method: `get`,\n        url: `/item/e7f7082a-4f16-430d-8c3b-db6b8d4d3e73`,\n      })\n      .then(async (response) => ({\n        statusCode: response.statusCode,\n        body: await response.json(),\n      })),\n  ).resolves.toEqual({\n    statusCode: 404,\n    body: {\n      id: `e7f7082a-4f16-430d-8c3b-db6b8d4d3e73`,\n      message: `item not found`,\n    },\n  });\n\n  await expect(\n    f\n      .inject({\n        method: `post`,\n        url: `/item`,\n        payload: {\n          id: `e7f7082a-4f16-430d-8c3b-db6b8d4d3e73`,\n          label: `todo`,\n          state: `todo`,\n          dueDateMs: new Date(1337).getTime(),\n        },\n      })\n      .then((res) => res.json()),\n  ).resolves.toEqual({\n    todoItems: [\n      {\n        id: `e7f7082a-4f16-430d-8c3b-db6b8d4d3e73`,\n        label: `todo`,\n        state: `todo`,\n        dueDateMs: new Date(1337).getTime(),\n      },\n    ],\n  });\n\n  await expect(\n    f\n      .inject({\n        method: `get`,\n        url: `/item/e7f7082a-4f16-430d-8c3b-db6b8d4d3e73`,\n      })\n      .then(async (response) => ({\n        statusCode: response.statusCode,\n        body: await response.json(),\n      })),\n  ).resolves.toEqual({\n    statusCode: 200,\n    body: {\n      id: `e7f7082a-4f16-430d-8c3b-db6b8d4d3e73`,\n      label: `todo`,\n      state: `todo`,\n      dueDateMs: new Date(1337).getTime(),\n    },\n  });\n\n  await expect(\n    f\n      .inject({\n        method: `put`,\n        url: `/item/1337`,\n      })\n      .then((res) => res.json()),\n  ).resolves.toEqual({\n    code: `FST_ERR_VALIDATION`,\n    error: `Bad Request`,\n    message: `params/id invalid todo item id`,\n    statusCode: 400,\n  });\n});\n"],"mappings":"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"}